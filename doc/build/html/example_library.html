
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Example: Create Sample Library &#8212; KLayout Photonic PCells 0.1 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tips &amp; Tricks" href="tips.html" />
    <link rel="prev" title="photonics package" href="photonics.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="tips.html" title="Tips &amp; Tricks"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="photonics.html" title="photonics package"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">KLayout Photonic PCells 0.1 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="example-create-sample-library">
<h1>Example: Create Sample Library<a class="headerlink" href="#example-create-sample-library" title="Permalink to this headline">¶</a></h1>
<p>In this chapter we will create an example library consisting of an MMI built with a box and linear tapers. The finished file can
be found in <a class="reference download internal" download="" href="_downloads/f3758374ddaedb1c85d2db8f9efb9e40/MMI_Example.lym"><code class="xref download docutils literal notranslate"><span class="pre">MMI_Example.lym</span></code></a>. This file can be copied into the KLayout pymacros folder (<code class="file docutils literal notranslate"><span class="pre">~/.klayout/pymacros/</span></code>) and executed. The chapter is an in-depth explanation of the example.</p>
<p>All photonic libraries are derived from <a class="reference internal" href="photonics.html#photonics.PhotDevice" title="photonics.PhotDevice"><code class="xref py py-class docutils literal notranslate"><span class="pre">PhotDevice</span></code></a>.</p>
<p>As an example, we will use a modified FreePDK45_Cell. We will create a 2x2 MMI.
To create a new PCell Library open the MacroDevelopment of Klayout in the menu Macros-&gt;MacroDevelopment.</p>
<div class="figure" id="id1">
<a class="reference internal image-reference" href="_images/Macros.png"><img alt="Open the IDE through Macros-&gt;MacroDevelopment" src="_images/Macros.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-number">Fig. 3 </span><span class="caption-text">Open the IDE through <span class="menuselection">Macros‣MacroDevelopment</span></span></p>
</div>
<p>This will open the KLayout Ruby/Python/DRC IDE. In the left sidebar choose Python as a language. In the menu choose
new (second to the left, the plus sign) to create a new script/library.</p>
<div class="figure" id="id2">
<a class="reference internal image-reference" href="_images/Add_new_Lib.png"><img alt="Add a new PCell template" src="_images/Add_new_Lib.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-number">Fig. 4 </span><span class="caption-text">Add a new PCell template from the Context</span></p>
</div>
<p>From the opening context choose <em>PCell template (Python)</em>. This will create a new <cite>.lym</cite> file for a PCell-Library.
The generated sample code is irrelevant for us as we will not use KLayout syntax, but the extension.
The reason for choosing the PCell Sample instead of an empty template is, that it will be flagged as a PCell library in
the background.</p>
<div class="figure" id="id3">
<a class="reference internal image-reference" href="_images/Add_new_Lib_2.png"><img alt="Choose PCell template (Python)" src="_images/Add_new_Lib_2.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-number">Fig. 5 </span><span class="caption-text">Choose PCell template (Python)</span></p>
</div>
<p>As a next step delete all example code. The new cell will be created from scratch. Reason for using the sample PCell is that KLayout
uses some flags to define it as a PCell library.</p>
<p>First let’s import modules we will need.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pya</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">photonics</span> <span class="kn">import</span> <span class="n">PhotDevice</span><span class="p">,</span> <span class="n">PortCreation</span>
<span class="kn">import</span> <span class="nn">photonics.layermaps</span> <span class="kn">as</span> <span class="nn">lm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</td></tr></table></div>
<p>After the imports we will create a helper class. The class photonics.PhotDevice is technology-independent and
thus needs to be supplied with information about layers, i.e. how to map layers during dataprep and finally about
the constraints for the DR-Cleaning. So let’s define a helper class that all of our FreePDK45-PCells will use.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FreePDK45Example</span><span class="p">(</span><span class="n">PhotDevice</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that provides technology specific data. Currently the backend needs 3 things to be supplied by the technology of the PCells.</span>
<span class="sd">    As these are independent of specific PCells and parameters this should not give any difficulty with the requirement of Klayout to have the Classes stateless.</span>

<span class="sd">    The layermap was created from a forum suggestion</span>
<span class="sd">        (`Post &lt;https://community.cadence.com/cadence_technology_forums/f/custom-ic-design/37021/layer-map-file-for-gds-transfer-to-virtuoso&gt;` ) and then some layers were added by hand.</span>

<span class="sd">        layermap:       A dictionary containing layers with available purposes, which provide a layer/purpose. This is loaded from a .layermap file.</span>
<span class="sd">                        Example of this FreePDK45:</span>
<span class="sd">                            {&#39;active&#39;: {&#39;blockage&#39;: (1, 1), &#39;drawing&#39;: (1, 0)}, &#39;pwell&#39;: {&#39;blockage&#39;: (2, 1), &#39;drawing&#39;: (2, 0)},...}</span>

<span class="sd">        :ivar dataprep_config: Filepath to a text file containing rules for dataprep. This file contains rules for the dataprep.</span>
<span class="sd">                        Copied from the example dataprep.txt:</span>
<span class="sd">                        File Format:</span>
<span class="sd">                        File defining operations for dataprep</span>
<span class="sd">                        Format:</span>
<span class="sd">                        &lt;operation&gt; &lt;source layers&gt; &lt;destination layers&gt; &lt;sizing amount in microns&gt;</span>
<span class="sd">                        Operations supported: add,sub</span>
<span class="sd">                            * add: Create a region from all shapes of the source layers and combine this region with each destion layer region separately</span>
<span class="sd">                            * sub: Same as add but don&#39;t build combination but cross-section instead</span>
<span class="sd">                        Sizing amount uses the klayout sizing operation to size the regions of the source layers</span>
<span class="sd">                        During dataprep the regions are merged, meaning overlapping polygons will become one Polygon</span>
<span class="sd">                        source/destination layers are separated by commas if there are multiple</span>
<span class="sd">                        Each argument is separated by white spaces. How many should not matter as they will be parsed by a python str.split() operation which should be able to handle any white space amount.</span>
<span class="sd">                        If the first word of a line is not a supported operation the line will be ignored</span>
<span class="sd">                        The lines will be executed in order meaning and add sub operations on layers will be different than a first sub and then add</span>
<span class="sd">                        :Examples:</span>
<span class="sd">                            active.blockage,poly.blockage,metal1.blockage,metal2.blockage,metal3.blockage,metal4.blockage,metal5.blockage,nwell.drawing,nimplant.drawing 2.0</span>

<span class="sd">        :ivar clean_rules:     list containing the layer/purpose numbers and the minWidth/minSpacing rules for the layer/purpose pair in microns</span>
<span class="sd">                        :Examples:</span>
<span class="sd">                            [[(1, 0), 0.097, 0.077],[(2, 0), 0.23, 0.189],[(3, 0), 0.169, 0.196],[(5, 0), 0.044, 0.052], ...]</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="c1"># Define the metals &amp; via names. They will be used in some PCells (Electrodes and ViaStack)</span>
    <span class="n">metal_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metal&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)]</span>
    <span class="n">via_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;via&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">PhotDevice</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">techpath</span> <span class="o">=</span> <span class="n">pya</span><span class="o">.</span><span class="n">Technology</span><span class="o">.</span><span class="n">technology_by_name</span><span class="p">(</span><span class="s1">&#39;FreePDK45&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">base_path</span><span class="p">()</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">techpath</span> <span class="o">+</span> <span class="s1">&#39;/FreePDK45.tf&#39;</span>

        <span class="c1"># Check if techfile is correctly imported and located</span>

        <span class="n">isfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfile</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">sys</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">pya</span><span class="o">.</span><span class="n">QMessageBox</span><span class="p">(</span><span class="n">pya</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">main_window</span><span class="p">())</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;Please import the techfile of the technology to {} before using the module and reopen KLayout&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">windowTitle</span> <span class="o">=</span> <span class="s1">&#39;ImportError&#39;</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="n">tech</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">load_from_tech</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># Get the layermap file and load it.</span>
        <span class="c1"># CAREFUL: Will be used for dataprep and others</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layermap</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">techpath</span> <span class="o">+</span> <span class="s1">&#39;/FreePDK45.layermap&#39;</span><span class="p">)</span>

        <span class="c1"># This variable will be imported by the dataprep algorithm</span>
        <span class="c1"># CAREFUL: Will be imported for dataprep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataprep_config</span> <span class="o">=</span> <span class="n">techpath</span> <span class="o">+</span> <span class="s1">&#39;/dataprep.txt&#39;</span>

        <span class="c1"># Rules for the cleaner in the form [[(layer1,purpose1),violation_width1,violation_space1],[(layer2,purpose2),violation_width2,violation_space2],...]</span>
        <span class="c1">### CAREFUL: This variable will be imported for the cleaning.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_rules</span> <span class="o">=</span> <span class="p">[[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.111</span><span class="p">,</span> <span class="mf">0.085</span><span class="p">],</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.23</span><span class="p">,</span> <span class="mf">0.188</span><span class="p">],</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.199</span><span class="p">],</span> <span class="p">[(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.044</span><span class="p">,</span> <span class="mf">0.049</span><span class="p">],</span>
                            <span class="p">[(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.046</span><span class="p">,</span> <span class="mf">0.052</span><span class="p">],</span> <span class="p">[(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.044</span><span class="p">,</span> <span class="mf">0.062</span><span class="p">],</span> <span class="p">[(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.076</span><span class="p">,</span> <span class="mf">0.077</span><span class="p">],</span> <span class="p">[(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.073</span><span class="p">,</span> <span class="mf">0.089</span><span class="p">],</span>
                            <span class="p">[(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.067</span><span class="p">,</span> <span class="mf">0.063</span><span class="p">],</span> <span class="p">[(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.143</span><span class="p">,</span> <span class="mf">0.137</span><span class="p">],</span> <span class="p">[(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.158</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">],</span> <span class="p">[(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.145</span><span class="p">,</span> <span class="mf">0.123</span><span class="p">],</span>
                            <span class="p">[(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.514</span><span class="p">,</span> <span class="mf">0.535</span><span class="p">],</span> <span class="p">[(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.369</span><span class="p">,</span> <span class="mf">0.311</span><span class="p">],</span> <span class="p">[(</span><span class="mi">27</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.908</span><span class="p">,</span> <span class="mf">0.843</span><span class="p">],</span> <span class="p">[(</span><span class="mi">29</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.347</span><span class="p">,</span> <span class="mf">0.771</span><span class="p">],</span>
                            <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1.247</span><span class="p">,</span> <span class="mf">1.254</span><span class="p">],</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.976</span><span class="p">,</span> <span class="mf">0.905</span><span class="p">],</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1.165</span><span class="p">,</span> <span class="mf">1.304</span><span class="p">],</span> <span class="p">[(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1.073</span><span class="p">,</span> <span class="mf">0.958</span><span class="p">],</span>
                            <span class="p">[(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1.058</span><span class="p">,</span> <span class="mf">0.885</span><span class="p">],</span> <span class="p">[(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.892</span><span class="p">,</span> <span class="mf">0.825</span><span class="p">],</span> <span class="p">[(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1.003</span><span class="p">,</span> <span class="mf">0.682</span><span class="p">],</span> <span class="p">[(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.983</span><span class="p">,</span> <span class="mf">0.73</span><span class="p">],</span>
                            <span class="p">[(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1.086</span><span class="p">,</span> <span class="mf">0.993</span><span class="p">],</span> <span class="p">[(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1.12</span><span class="p">,</span> <span class="mf">0.812</span><span class="p">],</span> <span class="p">[(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.941</span><span class="p">,</span> <span class="mf">0.765</span><span class="p">],</span> <span class="p">[(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.942</span><span class="p">,</span> <span class="mf">0.889</span><span class="p">],</span>
                            <span class="p">[(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1.044</span><span class="p">,</span> <span class="mf">0.933</span><span class="p">],</span> <span class="p">[(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1.096</span><span class="p">,</span> <span class="mf">1.039</span><span class="p">],</span> <span class="p">[(</span><span class="mi">27</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.798</span><span class="p">,</span> <span class="mf">0.937</span><span class="p">],</span> <span class="p">[(</span><span class="mi">29</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1.001</span><span class="p">,</span> <span class="mf">1.286</span><span class="p">]]</span>
</pre></div>
</td></tr></table></div>
<p>This is our basic class. Now let’s create two basic PCells. First a linear taper and second a box. A box combined
with 4 tapers will build a 2x2 MMI. To connect them we will use ports. The liner taper will have two ports, one on
each side. The box will have four ports and each port of the box is the same size as the big part of the taper.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ExMMIBody</span><span class="p">(</span><span class="n">FreePDK45Example</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MMI Body. Since this should be a 2x2 MMI it will have 4 ports</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">FreePDK45Example</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_layer</span><span class="p">(</span><span class="s1">&#39;lay&#39;</span><span class="p">,</span><span class="s2">&quot;active.drawing&quot;</span><span class="p">)</span>
        <span class="c1"># Important: If it should be a floating point parameter, use x.0 instead of x for default values that fall on integers, or it will be interpreted as integer</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mf">15.</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span>
                    <span class="n">port_offset</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                    <span class="n">port_width</span> <span class="o">=</span><span class="mf">1.0</span>
                    <span class="p">)</span>
        <span class="c1"># Register the parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_param_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Create Ports here</span>
        <span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="n">PortCreation</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_offset</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_width</span><span class="p">),</span>
                <span class="n">PortCreation</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">port_offset</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_width</span><span class="p">),</span>
                <span class="n">PortCreation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">port_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_width</span><span class="p">),</span>
                <span class="n">PortCreation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_width</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">ports</span>

    <span class="k">def</span> <span class="nf">shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#Create the Rectangle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_polygon</span><span class="p">([[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">],[</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">],[</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">]],</span><span class="bp">self</span><span class="o">.</span><span class="n">lay</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ExLinTaper</span><span class="p">(</span><span class="n">FreePDK45Example</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">FreePDK45Example</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_layer</span><span class="p">(</span><span class="s1">&#39;lay&#39;</span><span class="p">,</span><span class="s2">&quot;active.drawing&quot;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">width_0</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">width_1</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_param_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Create left and right port</span>
        <span class="n">port_0</span> <span class="o">=</span> <span class="n">PortCreation</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">width_0</span><span class="p">)</span>
        <span class="n">port_1</span> <span class="o">=</span> <span class="n">PortCreation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">width_1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">port_0</span><span class="p">,</span><span class="n">port_1</span>

    <span class="k">def</span> <span class="nf">shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Create taper polygon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_polygon</span><span class="p">([[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">width_0</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
                            <span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">width_0</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
                            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">width_1</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
                            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">width_1</span><span class="o">/</span><span class="mi">2</span><span class="p">],],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">lay</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If we only declare one <a class="reference internal" href="photonics.html#photonics.PortCreation" title="photonics.PortCreation"><code class="xref py py-class docutils literal notranslate"><span class="pre">PortCreation</span></code></a> in self.create_param_inst(self), we have to return it as: <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">[port]</span></code></p>
</div>
<p>Now let’s declare the MMI. In it we will create 4 instances of tapers and one box and then connect the tapers to
the box.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Ex2x2MMI</span><span class="p">(</span><span class="n">FreePDK45Example</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The MMI-cell class.</span>
<span class="sd">    This class instantiates a body with 4 tapers and attaches the tapers to the the body.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">FreePDK45Example</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_layer</span><span class="p">(</span><span class="s1">&#39;lay&#39;</span><span class="p">,</span><span class="s1">&#39;active.drawing&#39;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">wg_width</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">length</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span>
                    <span class="n">taper_width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">taper_length</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                    <span class="n">taper_offset</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_param_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Library we load the sub-cells from</span>
        <span class="n">lib</span> <span class="o">=</span> <span class="s2">&quot;FreePDK45_Photonic_FirstExample&quot;</span>
        <span class="n">bodyname</span> <span class="o">=</span> <span class="s2">&quot;MMIBody&quot;</span>
        <span class="n">tapername</span> <span class="o">=</span> <span class="s2">&quot;LinearTaper&quot;</span>

        <span class="c1"># Parameters used for the 4-port body</span>
        <span class="n">body_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lib</span> <span class="o">=</span> <span class="n">lib</span><span class="p">,</span>
                            <span class="n">cellname</span> <span class="o">=</span> <span class="n">bodyname</span><span class="p">,</span>
                            <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                            <span class="n">length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
                            <span class="n">port_offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taper_offset</span><span class="p">,</span>
                            <span class="n">port_width</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taper_width</span><span class="p">,</span>
                            <span class="p">)</span>
        <span class="c1"># Parameters for tapers</span>
        <span class="n">taper_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lib</span> <span class="o">=</span> <span class="n">lib</span><span class="p">,</span>
                            <span class="n">cellname</span> <span class="o">=</span> <span class="n">tapername</span><span class="p">,</span>
                            <span class="n">width_0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wg_width</span><span class="p">,</span>
                            <span class="n">width_1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taper_width</span><span class="p">,</span>
                            <span class="n">length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taper_length</span><span class="p">,</span>
                            <span class="p">)</span>
        <span class="c1"># Create constructors for tapers and body</span>
        <span class="n">tapers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_pcell_variant</span><span class="p">(</span><span class="n">taper_params</span><span class="p">,</span><span class="n">number</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_pcell_variant</span><span class="p">(</span><span class="n">body_params</span><span class="p">)</span>

        <span class="c1"># Connect the ports</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect_port_to_port</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">port</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">tapers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">port</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Return constructors</span>
        <span class="k">return</span> <span class="n">tapers</span><span class="p">,</span><span class="n">body</span>
</pre></div>
</td></tr></table></div>
<p>Finally create the Library so that we can call it in KLayout:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>188
189
190
191
192
193
194
195
196
197
198</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FreePDK45_ExampleLib</span><span class="p">(</span><span class="n">pya</span><span class="o">.</span><span class="n">Library</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Set the description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;FirstExample&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">technology</span> <span class="o">=</span> <span class="s2">&quot;FreePDK45&quot;</span>
        <span class="c1"># Create the PCell declarations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">register_pcell</span><span class="p">(</span><span class="s2">&quot;2x2MMI&quot;</span><span class="p">,</span><span class="n">Ex2x2MMI</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">register_pcell</span><span class="p">(</span><span class="s2">&quot;MMIBody&quot;</span><span class="p">,</span><span class="n">ExMMIBody</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">register_pcell</span><span class="p">(</span><span class="s2">&quot;LinearTaper&quot;</span><span class="p">,</span><span class="n">ExLinTaper</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;FreePDK45_Photonic_FirstExample&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>And finally make KLayout compile the PCell-Library and add it to the PCell-Libraries:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>200
201</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Instantiate and register the library</span>
<span class="n">FreePDK45_ExampleLib</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>Click <code class="docutils literal notranslate"><span class="pre">Run</span> <span class="pre">script</span> <span class="pre">from</span> <span class="pre">the</span> <span class="pre">current</span> <span class="pre">tab</span></code> (Green Arrow with a vertical line at the end).</p>
<p>Now you can create Instances of this parametric cell in the main window of Klayout. Click on Instance and
choose the <code class="docutils literal notranslate"><span class="pre">FreePDK</span> <span class="pre">Sample</span> <span class="pre">Cells</span> <span class="pre">[Technology</span> <span class="pre">FreePDK45]</span></code> library from the drop-down menu. On the left of the library
drop down you can choose one of the three cells. And in the tab you can adjust parameters.</p>
<div class="figure" id="id4">
<a class="reference internal image-reference" href="_images/Instance.png"><img alt="In the main window click on Instance to create instances of the new Cell" src="_images/Instance.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-number">Fig. 6 </span><span class="caption-text">In the main window click on Instance to create instances of the new Cell</span></p>
</div>
<p>If you click <strong>Ok</strong> or <strong>Apply</strong> you can place the new Cell with adjusted parameters. The first boolean determines
whether the cell should contain only dataprep &amp; design rule cleaned shapes or all shapes. The second tells the
cell to perform dataprep and the last to make it DR-clean. The rest of the parameters are PCell specific and should
be the ones defined in the <code class="docutils literal notranslate"><span class="pre">__init__(self)</span></code> function of the cell definition.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="photonics.html"
                        title="previous chapter">photonics package</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="tips.html"
                        title="next chapter">Tips &amp; Tricks</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/example_library.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="tips.html" title="Tips &amp; Tricks"
             >next</a> |</li>
        <li class="right" >
          <a href="photonics.html" title="photonics package"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">KLayout Photonic PCells 0.1 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Sebastian Goeldi.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
  </body>
</html>